<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aikya Guest Registration</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load Google Fonts for Handwriting -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="shortcut icon" href="logo.png" type="image/x-icon">
    
    <!-- Tailwind Configuration with Custom Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#662222', // Deep Red/Brown - Used for background and dark base
                        'secondary-accent': '#842A3B', // Mid Red/Brown - Used for buttons and key accents
                        'tertiary-highlight': '#A3485A', // Lighter Red/Brown - Used for borders and section headers
                        'text-light': '#F5DAA7', // Light Gold/Tan - Used for text and light backgrounds
                    },
                    fontFamily: {
                        'handwriting': ['Dancing Script', 'cursive'],
                    }
                },
            },
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            /* Applying primary-dark to the body background */
            background-color: #662222; 
        }
        
        /* Custom Scrollbar for Admin Table */
        .scrollable-table::-webkit-scrollbar { 
            height: 8px; 
            width: 8px;
        }
        .scrollable-table::-webkit-scrollbar-thumb { 
            background: linear-gradient(90deg, #842A3B, #A3485A);
            border-radius: 6px; 
        }
        .scrollable-table::-webkit-scrollbar-track { 
            background: #441111; /* Dark track for contrast */
            border-radius: 6px;
        }
        
        /* Glassmorphism Effect for Admin Sidebar (FIXED READABILITY) */
        .glass-effect {
            backdrop-filter: blur(20px);
            /* Darker, more opaque background based on primary-dark for readability */
            background: rgba(102, 34, 34, 0.9); /* #662222 with 90% opacity */
            border: 1px solid rgba(245, 218, 167, 0.5); /* Border uses text-light with transparency */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            color: #F5DAA7; /* Ensure all text inside is the light color */
        }

        .admin-sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .admin-sidebar.open {
            transform: translateX(0);
        }
        
        /* Hides the default calendar icon provided by the browser, */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        /* Loading Spinner Color */
        .spinner {
            border-top-color: #F5DAA7; /* Use light text color for visibility */
            -webkit-animation: spin 1s infinite linear;
            animation: spin 1s infinite linear;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Co-guest form styling */
        .co-guest-form {
            border-left: 4px solid #A3485A;
            transition: all 0.3s ease;
        }
        
        .co-guest-form:hover {
            border-left-color: #F5DAA7;
            background-color: rgba(245, 218, 167, 0.1);
        }
        
        /* Enhanced Admin Button Styles */
        .admin-portal-btn {
            background: linear-gradient(135deg, #842A3B 0%, #A3485A 100%);
            box-shadow: 0 4px 15px rgba(132, 42, 59, 0.4);
            transition: all 0.3s ease;
            border: 2px solid rgba(245, 218, 167, 0.3);
        }
        
        .admin-portal-btn:hover {
            background: linear-gradient(135deg, #A3485A 0%, #842A3B 100%);
            box-shadow: 0 6px 20px rgba(132, 42, 59, 0.6);
            transform: translateY(-2px);
        }
        
        .admin-portal-btn:active {
            transform: translateY(0);
        }
        
        .pulse-ring {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(132, 42, 59, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(132, 42, 59, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(132, 42, 59, 0);
            }
        }

        /* Responsive Admin Sidebar */
        @media (min-width: 768px) and (max-width: 1024px) {
            /* iPad specific styles */
            .admin-sidebar {
                width: 70% !important;
            }
        }

        @media (min-width: 1025px) and (max-width: 1280px) {
            /* Small desktop / large tablet */
            .admin-sidebar {
                width: 50% !important;
            }
        }

        @media (min-width: 1281px) {
            /* Large desktop */
            .admin-sidebar {
                width: 35% !important;
            }
        }

        /* Thank You Page Styles - FIXED ANIMATIONS */
        .thank-you-container {
            background: linear-gradient(135deg, #662222 0%, #842A3B 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Floating Elements Animation */
        .floating-element {
            position: absolute;
            background: rgba(245, 218, 167, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        /* Simple Clean Checkmark Animation */
        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem auto;
        }

        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke: #F5DAA8;
            stroke-width: 4;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px #F5DAA7;
            animation: fill-checkmark .4s ease-in-out .4s forwards;
        }

        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 4;
            stroke-miterlimit: 10;
            stroke: #F5DAA7;
            fill: none;
            animation: stroke-checkmark 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark-check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    stroke: #842A3B; /* Dark red color for checkmark for contrast */
    stroke-width: 4;
    animation: stroke-checkmark 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }


        @keyframes stroke-checkmark {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes fill-checkmark {
            100% {
                box-shadow: inset 0px 0px 0px 40px #F5DAA7;
            }
        }

        /* Glow Animation for Registration ID */
        .glow-text {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px #F5DAA7, 0 0 10px #F5DAA7;
            }
            to {
                text-shadow: 0 0 10px #F5DAA7, 0 0 20px #F5DAA7, 0 0 30px #842A3B;
            }
        }

        /* Card Entrance Animation */
        .card-entrance {
            animation: cardEntrance 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }

        @keyframes cardEntrance {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Background Pattern */
        .background-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(245, 218, 167, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(163, 72, 90, 0.05) 0%, transparent 50%);
            animation: patternMove 15s ease-in-out infinite;
        }

        @keyframes patternMove {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-10px, -10px) scale(1.02); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative">

    <!-- Success/Error Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-all duration-300 opacity-0 transform translate-y-[-20px] pointer-events-none">
        <!-- Content will be inserted here -->
    </div>

    <!-- Thank You Page (Initially Hidden) - FIXED ANIMATIONS -->
    <div id="thank-you-page" class="thank-you-container fixed inset-0 z-50 hidden">
        <!-- Background Pattern -->
        <div class="background-pattern"></div>
        
        <!-- Floating Elements -->
        <div class="floating-element w-20 h-20 top-1/4 left-1/4" style="animation-delay: 0s;"></div>
        <div class="floating-element w-12 h-12 top-1/3 right-1/4" style="animation-delay: 2s;"></div>
        <div class="floating-element w-16 h-16 bottom-1/4 left-1/3" style="animation-delay: 4s;"></div>
        
        <div class="max-w-2xl w-full p-8 text-center relative z-10">
            <div class="bg-text-light/90 backdrop-blur-sm rounded-2xl p-8 shadow-2xl border border-tertiary-highlight/50 card-entrance">
                <!-- Fixed Success Checkmark -->
                <div class="success-checkmark">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                        <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                    </svg>
                </div>
                
                <h1 class="text-5xl font-handwriting text-secondary-accent mb-6">Thank You!</h1>
                <p class="text-xl text-primary-dark mb-6">Your registration has been successfully submitted.</p>
                
                <div class="bg-primary-dark/10 p-6 rounded-xl border border-secondary-accent/30 mb-8 transition-all duration-300 hover:shadow-lg">
                    <p class="text-lg text-primary-dark mb-2">Your Registration ID:</p>
                    <p id="registration-id-display" class="text-3xl font-bold text-secondary-accent font-mono glow-text"></p>
                </div>
                
                <p class="text-primary-dark mb-8">Please keep this registration ID for future reference.</p>
                
                <button id="new-registration-btn" class="px-8 py-4 bg-gradient-to-r from-secondary-accent to-tertiary-highlight text-text-light rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 font-semibold text-lg">
                    Start New Registration
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div id="main-card" class="w-full max-w-4xl p-8 bg-text-light rounded-xl shadow-2xl relative">
        <!-- Header with Logo -->
        <div class="flex flex-col items-center mb-8">
            <div class="flex items-center justify-center space-x-6 mb-4">
                <div class="w-24 h-24 bg-gradient-to-br from-secondary-accent to-tertiary-highlight rounded-xl flex items-center justify-center shadow-lg">
                    <img src="logo.png" alt="Aikya Logo" class="w-20 h-20 object-contain">
                </div>
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-secondary-accent">AIKYA</h1>
                    <p class="text-lg text-secondary-accent font-medium mt-2">Guest Registration</p>
                </div>
            </div>
        </div>
        
        <!-- Returning Guest Section -->
        <div id="returning-guest-section" class="p-6 rounded-lg bg-text-light/50 border border-tertiary-highlight/50 shadow-md mb-6 hidden">
            <h2 class="text-xl font-semibold text-tertiary-highlight mb-4">Welcome Back!</h2>
            <p class="text-gray-700 mb-4">We found previous registrations for this phone number. Please select which co-guests are staying with you this time:</p>
            
            <div id="previous-co-guests-container" class="space-y-4 mb-6">
                <!-- Previous co-guests will be inserted here -->
            </div>
            
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-600">You can add new co-guests after confirming these selections.</p>
                <button type="button" id="confirm-previous-guests" class="px-4 py-2 bg-secondary-accent text-text-light rounded-lg hover:bg-tertiary-highlight transition duration-150">
                    Confirm Selection
                </button>
            </div>
        </div>
        
        <form id="registration-form" class="space-y-6">
            
            <!-- Guest Details Section -->
            <div class="p-6 rounded-lg bg-text-light/50 border border-tertiary-highlight/50 shadow-md">
                <h2 class="text-xl font-semibold text-tertiary-highlight mb-4">Your Details</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="guest-name" class="block text-sm font-medium text-gray-700 mb-1">Guest Name</label>
                        <input type="text" id="guest-name" name="guest_name" required 
                               class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-tertiary-highlight focus:border-tertiary-highlight transition duration-150">
                    </div>
                    <div>
                        <label for="phone-number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="phone-number" name="phone_number" required 
                               pattern="[0-9]{10}" title="Ten digits phone number"
                               class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-tertiary-highlight focus:border-tertiary-highlight transition duration-150">
                        <div id="phone-check-status" class="text-xs mt-1 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Stay Details Section -->
            <div class="p-6 rounded-lg bg-text-light/50 border border-tertiary-highlight/50 shadow-md">
                <h2 class="text-xl font-semibold text-tertiary-highlight mb-4">Stay & Purpose</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Check-in Date with Icon -->
                    <div>
                        <label for="check-in-date" class="block text-sm font-medium text-gray-700 mb-1">Check-in Date</label>
                        <div class="relative flex items-center">
                            <input type="date" id="check-in-date" name="check_in_date" required 
                                   class="w-full pr-10 pl-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-tertiary-highlight focus:border-tertiary-highlight transition duration-150">
                            <svg class="w-5 h-5 absolute right-3 text-tertiary-highlight pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                    </div>
                    
                    <!-- Check-out Date with Icon -->
                    <div>
                        <label for="check-out-date" class="block text-sm font-medium text-gray-700 mb-1">Check-out Date</label>
                        <div class="relative flex items-center">
                            <input type="date" id="check-out-date" name="check_out_date" required 
                                   class="w-full pr-10 pl-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-tertiary-highlight focus:border-tertiary-highlight transition duration-150">
                            <svg class="w-5 h-5 absolute right-3 text-tertiary-highlight pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                    </div>

                    <div>
                        <label for="purpose-of-visit" class="block text-sm font-medium text-gray-700 mb-1">Purpose of Visit</label>
                        <select id="purpose-of-visit" name="purpose_of_visit" required 
                                class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-tertiary-highlight focus:border-tertiary-highlight transition duration-150 appearance-none bg-white">
                            <option value="">Select Purpose</option>
                            <option value="Business">Business</option>
                            <option value="Personal">Personal/Leisure</option>
                            <option value="Family Event">Family Event</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ID Proof Section -->
            <div class="p-6 rounded-lg bg-text-light/50 border border-tertiary-highlight/50 shadow-md">
                <h2 class="text-xl font-semibold text-tertiary-highlight mb-4">
                    Main Guest ID Proof
                    <span id="main-guest-returning-indicator" class="text-sm text-secondary-accent ml-2 hidden">(Returning Guest)</span>
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="id-proof-type" class="block text-sm font-medium text-gray-700 mb-1">ID Proof Type</label>
                        <select id="id-proof-type" name="id_proof_type" required 
                                class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-tertiary-highlight focus:border-tertiary-highlight transition duration-150 appearance-none bg-white">
                            <option value="">Select ID Type</option>
                            <option value="Aadhar">Aadhar Card</option>
                            <option value="Driving License">Driving License</option>
                            <option value="PAN">PAN Card</option>
                            <option value="Voters ID">Voter's ID</option>
                            <option value="Passport">Passport</option>
                        </select>
                    </div>
                    <div>
                        <label for="id-proof-file" class="block text-sm font-medium text-gray-700 mb-1">
                            Upload ID Proof Document
                            <span id="main-guest-file-optional" class="text-xs text-tertiary-highlight ml-1 hidden">(Optional - Already on file)</span>
                        </label>
                        <input type="file" id="id-proof-file" name="id_proof_file" required 
                               accept=".jpg,.jpeg,.png,.pdf"
                               class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-tertiary-highlight/20 file:text-tertiary-highlight hover:file:bg-tertiary-highlight/30 transition duration-150">
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG or PDF (max 2MB)</p>
                        <p id="main-guest-id-status" class="text-xs text-tertiary-highlight mt-1 hidden">‚úì ID proof already uploaded in previous registration</p>
                    </div>
                </div>
            </div>

            <!-- Co-Guests Section -->
            <div class="p-6 rounded-lg bg-text-light/50 border border-tertiary-highlight/50 shadow-md space-y-4">
                <h2 class="text-xl font-semibold text-tertiary-highlight">Co-Guests</h2>
                <div id="co-guest-container" class="space-y-4">
                    <!-- Co-guest forms will be inserted here by JavaScript -->
                </div>
                <button type="button" id="add-guest-btn" class="flex items-center justify-center px-4 py-2 text-sm font-medium rounded-full border border-secondary-accent text-secondary-accent hover:bg-secondary-accent/10 transition duration-150">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    Add Co-Guest
                </button>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center pt-4">
                <button type="submit" id="submit-btn" 
                        class="w-full md:w-auto px-10 py-3 text-lg font-semibold bg-secondary-accent text-text-light rounded-xl shadow-lg hover:bg-tertiary-highlight focus:outline-none focus:ring-4 focus:ring-secondary-accent/50 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                    <span id="submit-text">Complete Registration</span>
                    <div id="loading-spinner" class="spinner h-5 w-5 border-2 rounded-full hidden ml-3"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- Enhanced Admin Menu Toggle Button -->
    <button id="admin-menu-toggle" class="fixed bottom-6 right-6 z-40 admin-portal-btn pulse-ring text-text-light font-bold rounded-2xl shadow-2xl transition duration-300 flex items-center space-x-3 p-4" onclick="toggleAdminMenu()">
        <!-- Shield Icon with Badge -->
        <div class="relative">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V10.7C15.4,10.9 16,11.3 16.4,11.9C17.2,13.1 16.9,14.7 15.6,15.5C14.3,16.3 12.7,16 11.9,14.8C11.6,14.2 11.7,13.6 12,13V10C12,9.4 12.4,9 13,9C13.6,9 14,9.4 14,10V10.7C14.6,10.4 15.3,10.2 16,10.3C16.7,10.4 17.3,10.8 17.7,11.4C18,12 18.1,12.7 17.9,13.4C17.3,15 15.7,15.9 14.1,15.6C12.9,15.3 12,14.3 12,13V10C12,8.9 12.9,8 14,8C15.1,8 16,8.9 16,10V11H18V10C18,7.8 16.2,6 14,6C11.8,6 10,7.8 10,10V13C10,15.2 11.8,17 14,17C15.1,17 16.1,16.6 16.8,15.9C17.6,15.2 18,14.1 18,13V11C18,8.8 16.2,7 14,7H12Z" />
            </svg>
            <div class="absolute -top-1 -right-1 w-3 h-3 bg-text-light rounded-full border-2 border-secondary-accent"></div>
        </div>
        <div class="text-left">
            <div class="font-semibold text-sm leading-tight">Admin</div>
            <div class="text-xs opacity-90 leading-tight">Portal</div>
        </div>
    </button>

    <!-- Alternative Floating Admin Button (Compact) -->
    <button id="admin-menu-toggle-compact" class="fixed bottom-6 right-6 z-40 admin-portal-btn text-text-light font-bold rounded-full shadow-2xl transition duration-300 flex items-center justify-center p-4 md:hidden" onclick="toggleAdminMenu()">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V10.7C15.4,10.9 16,11.3 16.4,11.9C17.2,13.1 16.9,14.7 15.6,15.5C14.3,16.3 12.7,16 11.9,14.8C11.6,14.2 11.7,13.6 12,13V10C12,9.4 12.4,9 13,9C13.6,9 14,9.4 14,10V10.7C14.6,10.4 15.3,10.2 16,10.3C16.7,10.4 17.3,10.8 17.7,11.4C18,12 18.1,12.7 17.9,13.4C17.3,15 15.7,15.9 14.1,15.6C12.9,15.3 12,14.3 12,13V10C12,8.9 12.9,8 14,8C15.1,8 16,8.9 16,10V11H18V10C18,7.8 16.2,6 14,6C11.8,6 10,7.8 10,10V13C10,15.2 11.8,17 14,17C15.1,17 16.1,16.6 16.8,15.9C17.6,15.2 18,14.1 18,13V11C18,8.8 16.2,7 14,7H12Z" />
        </svg>
    </button>

    <!-- Admin Menu Sidebar -->
    <div id="admin-sidebar" class="admin-sidebar fixed top-0 right-0 w-full md:w-3/4 lg:w-1/2 xl:w-1/3 2xl:w-1/4 h-full glass-effect shadow-2xl p-6 overflow-y-auto z-50">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Admin Portal</h2>
            <button onclick="toggleAdminMenu(false)" class="hover:text-tertiary-highlight transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Auth Section -->
        <div id="admin-auth-section">
            <h3 class="text-xl font-semibold mb-4">Admin Login</h3>
            <form id="admin-login-form" class="space-y-4">
                <input type="email" id="admin-email" placeholder="Email" required class="w-full px-4 py-2 rounded-lg bg-primary-dark/50 border border-text-light/50 text-text-light placeholder-text-light/80 focus:ring-tertiary-highlight focus:border-tertiary-highlight">
                <input type="password" id="admin-password" placeholder="Password" required class="w-full px-4 py-2 rounded-lg bg-primary-dark/50 border border-text-light/50 text-text-light placeholder-text-light/80 focus:ring-tertiary-highlight focus:border-tertiary-highlight">
                <button type="submit" class="w-full py-2 bg-secondary-accent text-text-light font-semibold rounded-lg hover:bg-tertiary-highlight transition duration-150">Login</button>
                <p id="auth-message" class="text-text-light text-center"></p>
            </form>
        </div>

        <!-- Data Section (Visible after login) -->
        <div id="admin-data-section" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <p class="text-sm">Logged in as Admin. User ID: <span id="admin-user-id" class="font-mono text-tertiary-highlight"></span></p>
                <button id="logout-btn" class="px-3 py-1 bg-tertiary-highlight text-text-light text-sm font-medium rounded-lg hover:bg-secondary-accent transition duration-150">Logout</button>
            </div>
            
            <!-- Date Filter -->
            <div class="p-4 rounded-lg bg-primary-dark/50 space-y-3 border border-text-light/50">
                <h3 class="font-medium">Filter Registrations by Date</h3>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Start Date Filter with Icon -->
                    <div class="relative flex items-center">
                        <input type="date" id="filter-start-date" class="pr-10 pl-3 py-2 rounded-lg bg-primary-dark text-text-light border border-tertiary-highlight w-full">
                        <svg class="w-5 h-5 absolute right-3 text-tertiary-highlight pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <!-- End Date Filter with Icon -->
                    <div class="relative flex items-center">
                        <input type="date" id="filter-end-date" class="pr-10 pl-3 py-2 rounded-lg bg-primary-dark text-text-light border border-tertiary-highlight w-full">
                        <svg class="w-5 h-5 absolute right-3 text-tertiary-highlight pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                </div>
                <button onclick="fetchGuests()" class="w-full py-2 bg-secondary-accent text-text-light font-semibold rounded-lg hover:bg-tertiary-highlight transition duration-150">Filter Guests</button>
            </div>

            <h3 class="text-xl font-semibold">Guest Registrations (<span id="guest-count">0</span>)</h3>
            
            <!-- Guest Table -->
            <div class="scrollable-table overflow-x-auto rounded-lg shadow-lg">
                <table class="min-w-full divide-y divide-primary-dark">
                    <thead class="bg-primary-dark">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-text-light uppercase tracking-wider">Reg ID</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-text-light uppercase tracking-wider">Name & Phone</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-text-light uppercase tracking-wider">Dates & Purpose</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-text-light uppercase tracking-wider">ID Type (Co-Guests)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-text-light uppercase tracking-wider">Registered At</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-text-light uppercase tracking-wider">ID Proof</th>
                        </tr>
                    </thead>
                    <tbody id="guest-list-body" class="bg-tertiary-highlight/10 divide-y divide-tertiary-highlight/30">
                        <!-- Guest rows will be inserted here -->
                        <tr id="loading-row" class="text-text-light text-center"><td colspan="6" class="p-4">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // =================================================================
        // GLOBAL VARIABLES & SUPABASE CONFIGURATION
        // =================================================================
        const SUPABASE_URL = 'https://jfloqndznzwdzfnuinan.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_KSCjYZlUC_0ceGiyqA2g0A_-5QC1rZN';

        // Initialize Supabase Client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const auth = supabaseClient.auth;
        const storage = supabaseClient.storage;

        // DOM Elements
        const registrationForm = document.getElementById('registration-form');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageBox = document.getElementById('message-box');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminAuthSection = document.getElementById('admin-auth-section');
        const adminDataSection = document.getElementById('admin-data-section');
        const guestListBody = document.getElementById('guest-list-body');
        const adminUserIdSpan = document.getElementById('admin-user-id');
        const coGuestContainer = document.getElementById('co-guest-container');
        const addGuestBtn = document.getElementById('add-guest-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const thankYouPage = document.getElementById('thank-you-page');
        const registrationIdDisplay = document.getElementById('registration-id-display');
        const newRegistrationBtn = document.getElementById('new-registration-btn');
        const returningGuestSection = document.getElementById('returning-guest-section');
        const previousCoGuestsContainer = document.getElementById('previous-co-guests-container');
        const confirmPreviousGuestsBtn = document.getElementById('confirm-previous-guests');
        const phoneNumberInput = document.getElementById('phone-number');
        const phoneCheckStatus = document.getElementById('phone-check-status');
        const mainGuestReturningIndicator = document.getElementById('main-guest-returning-indicator');
        const mainGuestFileOptional = document.getElementById('main-guest-file-optional');
        const mainGuestIdStatus = document.getElementById('main-guest-id-status');
        const idProofFileInput = document.getElementById('id-proof-file');
        const idProofTypeSelect = document.getElementById('id-proof-type');
        
        let coGuestCounter = 0;
        let previousCoGuests = [];
        let selectedPreviousGuests = [];
        let isMainGuestReturning = false;
        let mainGuestPreviousData = null;

        // =================================================================
        // UTILITY FUNCTIONS
        // =================================================================

        function showMessage(message, type) {
            const isSuccess = type === 'success';
            const bgColor = isSuccess ? 'bg-tertiary-highlight' : 'bg-primary-dark'; 
            const textColor = isSuccess ? 'text-text-light' : 'text-text-light'; 
            
            const icon = isSuccess ? 
                '<svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                '<svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';

            messageBox.innerHTML = `
                <div class="${bgColor} ${textColor} px-6 py-3 rounded-xl shadow-2xl flex items-center">
                    ${icon}
                    <p class="font-medium">${message}</p>
                </div>
            `;
            messageBox.classList.remove('opacity-0', 'translate-y-[-20px]');
            messageBox.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 5000);
        }

        function toggleLoading(isLoading) {
            submitBtn.disabled = isLoading;
            if (isLoading) {
                submitText.textContent = 'Processing...';
                loadingSpinner.classList.remove('hidden');
                submitBtn.classList.add('cursor-not-allowed');
            } else {
                submitText.textContent = 'Complete Registration';
                loadingSpinner.classList.add('hidden');
                submitBtn.classList.remove('cursor-not-allowed');
            }
        }

        function generateRegId() {
            const year = new Date().getFullYear();
            const suffix = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `REG-${year}-${suffix}`;
        }

        function getISTTimeString() {
            return new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true
            });
        }

        function validateFileSize(file) {
            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage('File size must be less than 2MB', 'error');
                return false;
            }
            return true;
        }

        function getAdjustedUTCFilterString(dateString, isEnd = false) {
            const date = new Date(dateString);
            let offsetMinutes = 330; 
            
            if (isEnd) {
                date.setDate(date.getDate() + 1); 
            }
            
            date.setMinutes(date.getMinutes() - offsetMinutes);
            return date.toISOString();
        }

        /**
         * Creates beautiful animations for thank you page
         */
        function createThankYouAnimations() {
            console.log('üéâ Thank you page with fixed animations displayed');
            // No need to create anything - CSS handles all animations now
        }

        // =================================================================
        // CO-GUEST MANAGEMENT - FIXED NUMBERING
        // =================================================================

        /**
         * Gets the current count of co-guest forms to maintain proper numbering
         */
        function getCurrentCoGuestCount() {
            return document.querySelectorAll('.co-guest-form').length;
        }

        /**
         * Creates and appends a new co-guest form element with proper numbering
         */
        function createCoGuestForm(guestData = null) {
            const currentCount = getCurrentCoGuestCount() + 1;
            const guestDiv = document.createElement('div');
            guestDiv.id = `co-guest-${currentCount}`;
            guestDiv.classList.add('co-guest-form', 'p-4', 'rounded-lg', 'bg-text-light/80', 'space-y-4');
            
            const nameValue = guestData ? guestData.name : '';
            const phoneValue = guestData ? guestData.phone_number : '';
            const idTypeValue = guestData ? guestData.id_proof_type : '';
            const isReturningGuest = !!guestData; // True if this is a returning guest
            
            const content = `
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-tertiary-highlight">
                        Co-Guest ${currentCount}
                        ${isReturningGuest ? '<span class="text-sm text-secondary-accent ml-2">(Returning Guest)</span>' : ''}
                    </h3>
                    <button type="button" onclick="removeCoGuest(${currentCount})" class="text-primary-dark hover:text-secondary-accent transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="co-guest-name-${currentCount}" class="block text-sm font-medium text-gray-700 mb-1">Co-Guest Name</label>
                        <input type="text" id="co-guest-name-${currentCount}" name="co_guest_name_${currentCount}" value="${nameValue}" required 
                               class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-secondary-accent focus:border-secondary-accent transition duration-150">
                    </div>
                    <div>
                        <label for="co-guest-phone-${currentCount}" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="co-guest-phone-${currentCount}" name="co_guest_phone_${currentCount}" value="${phoneValue}" required 
                               pattern="[0-9]{10}" title="Ten digits phone number"
                               class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-secondary-accent focus:border-secondary-accent transition duration-150">
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="co-guest-id-type-${currentCount}" class="block text-sm font-medium text-gray-700 mb-1">ID Proof Type</label>
                        <select id="co-guest-id-type-${currentCount}" name="co_guest_id_type_${currentCount}" required 
                                class="w-full px-4 py-2 border border-tertiary-highlight/40 rounded-lg focus:ring-secondary-accent focus:border-secondary-accent transition duration-150 appearance-none bg-white">
                            <option value="">Select ID Type</option>
                            <option value="Aadhar" ${idTypeValue === 'Aadhar' ? 'selected' : ''}>Aadhar Card</option>
                            <option value="Driving License" ${idTypeValue === 'Driving License' ? 'selected' : ''}>Driving License</option>
                            <option value="PAN" ${idTypeValue === 'PAN' ? 'selected' : ''}>PAN Card</option>
                            <option value="Voters ID" ${idTypeValue === 'Voters ID' ? 'selected' : ''}>Voter's ID</option>
                            <option value="Passport" ${idTypeValue === 'Passport' ? 'selected' : ''}>Passport</option>
                        </select>
                    </div>
                    <div>
                        <label for="co-guest-id-file-${currentCount}" class="block text-sm font-medium text-gray-700 mb-1">
                            Upload ID Proof Document
                            ${isReturningGuest ? '<span class="text-xs text-tertiary-highlight ml-1">(Optional - Already on file)</span>' : ''}
                        </label>
                        <input type="file" id="co-guest-id-file-${currentCount}" name="co_guest_id_file_${currentCount}" 
                               ${isReturningGuest ? '' : 'required'}
                               accept=".jpg,.jpeg,.png,.pdf"
                               class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-tertiary-highlight/20 file:text-tertiary-highlight hover:file:bg-tertiary-highlight/30 transition duration-150">
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG or PDF (max 2MB)</p>
                        ${isReturningGuest ? '<p class="text-xs text-tertiary-highlight mt-1">‚úì ID proof already uploaded in previous registration</p>' : ''}
                    </div>
                </div>
            `;

            guestDiv.innerHTML = content;
            coGuestContainer.appendChild(guestDiv);
        }

        /**
         * Adds a co-guest form with proper numbering
         */
        function addCoGuest() {
            createCoGuestForm();
        }

        /**
         * Removes a co-guest form by ID and renumbers remaining forms
         */
        function removeCoGuest(id) {
            const element = document.getElementById(`co-guest-${id}`);
            if (element) {
                element.remove();
                // Renumber remaining co-guest forms
                renumberCoGuestForms();
            }
        }

        /**
         * Renumbers all co-guest forms to maintain proper sequence
         */
        function renumberCoGuestForms() {
            const coGuestForms = document.querySelectorAll('.co-guest-form');
            coGuestForms.forEach((form, index) => {
                const newNumber = index + 1;
                const oldId = form.id;
                form.id = `co-guest-${newNumber}`;
                
                // Update the title
                const title = form.querySelector('h3');
                if (title) {
                    title.textContent = `Co-Guest ${newNumber}`;
                }
                
                // Update all input IDs and names
                const inputs = form.querySelectorAll('input, select, label');
                inputs.forEach(input => {
                    if (input.id) {
                        input.id = input.id.replace(/co-guest-(name|phone|id-type|id-file)-\d+/, `co-guest-$1-${newNumber}`);
                    }
                    if (input.htmlFor) {
                        input.htmlFor = input.htmlFor.replace(/co-guest-(name|phone|id-type|id-file)-\d+/, `co-guest-$1-${newNumber}`);
                    }
                    if (input.name) {
                        input.name = input.name.replace(/co_guest_(name|phone|id_type|id_file)_\d+/, `co_guest_$1_${newNumber}`);
                    }
                });
                
                // Update the remove button onclick
                const removeBtn = form.querySelector('button[onclick]');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeCoGuest(${newNumber})`);
                }
            });
        }

        // =================================================================
        // RETURNING GUEST HANDLING - UPDATED FOR MAIN GUEST
        // =================================================================

        /**
         * Checks if a phone number exists in previous registrations
         */
        async function checkReturningGuest(phoneNumber) {
            console.log('üîç Checking returning guest for phone:', phoneNumber);
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                console.log('‚ùå Invalid phone number format');
                return false;
            }

            try {
                previousCoGuests = [];
                mainGuestPreviousData = null;
                isMainGuestReturning = false;
                const seenPhones = new Set();

                // Get ALL registrations at once
                const { data: allGuests, error } = await supabaseClient
                    .from('guests')
                    .select('*');

                if (error) {
                    console.error('‚ùå Error fetching guests:', error);
                    return false;
                }

                console.log('üìä Total guests in database:', allGuests?.length);

                if (!allGuests || allGuests.length === 0) {
                    console.log('üì≠ No guests found in database');
                    return false;
                }

                let foundGuest = false;

                allGuests.forEach(registration => {
                    console.log('üìù Checking registration:', registration.reg_id, 'Main phone:', registration.phone_number);
                    
                    // Check if main guest matches
                    if (String(registration.phone_number) === String(phoneNumber)) {
                        console.log('‚úÖ Found as main guest in registration:', registration.reg_id);
                        foundGuest = true;
                        isMainGuestReturning = true;
                        mainGuestPreviousData = {
                            id_proof_type: registration.id_proof_type,
                            id_proof_url: registration.id_proof_url
                        };
                    }
                    
                    // Check co-guests
                    try {
                        const coGuests = JSON.parse(registration.co_guests || '[]');
                        console.log('üë• Co-guests in this registration:', coGuests.length);
                        
                        coGuests.forEach(guest => {
                            console.log('   üîç Checking co-guest:', guest.name, 'Phone:', guest.phone_number);
                            
                            // Check if this co-guest matches
                            if (String(guest.phone_number) === String(phoneNumber)) {
                                console.log('   ‚úÖ Found as co-guest');
                                foundGuest = true;
                            }
                            
                            // Add to previous co-guests list
                            if (guest.phone_number && 
                                String(guest.phone_number) !== String(phoneNumber) && 
                                !seenPhones.has(String(guest.phone_number))) {
                                console.log('   ‚ûï Adding to previous co-guests:', guest.name, guest.phone_number);
                                seenPhones.add(String(guest.phone_number));
                                previousCoGuests.push(guest);
                            }
                        });
                    } catch (e) {
                        console.error("‚ùå Failed to parse co_guests JSON:", e);
                    }
                });

                console.log('üìã Final previous co-guests count:', previousCoGuests.length);
                console.log('üìã Guest found status:', foundGuest);
                console.log('üìã Main guest returning:', isMainGuestReturning);
                console.log('üìã Main guest previous data:', mainGuestPreviousData);

                return foundGuest;

            } catch (error) {
                console.error('‚ùå Error in checkReturningGuest:', error);
                return false;
            }
        }

        /**
         * Updates the main guest form for returning guests
         */
        function updateMainGuestForm() {
            if (isMainGuestReturning && mainGuestPreviousData) {
                console.log('üîÑ Updating main guest form for returning guest');
                
                // Show returning guest indicator
                mainGuestReturningIndicator.classList.remove('hidden');
                
                // Set the ID proof type if available
                if (mainGuestPreviousData.id_proof_type) {
                    idProofTypeSelect.value = mainGuestPreviousData.id_proof_type;
                }
                
                // Update file input to be optional
                idProofFileInput.required = false;
                mainGuestFileOptional.classList.remove('hidden');
                mainGuestIdStatus.classList.remove('hidden');
                
                showMessage('Welcome back! Your ID proof is already on file.', 'success');
            } else {
                // Reset to default for new guests
                mainGuestReturningIndicator.classList.add('hidden');
                mainGuestFileOptional.classList.add('hidden');
                mainGuestIdStatus.classList.add('hidden');
                idProofFileInput.required = true;
            }
        }

        /**
         * Displays previous co-guests for selection
         */
        function displayPreviousCoGuests() {
            console.log('üéØ Displaying previous co-guests:', previousCoGuests);
            
            previousCoGuestsContainer.innerHTML = '';
            
            if (previousCoGuests.length === 0) {
                previousCoGuestsContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No previous co-guests found.</p>';
                return;
            }
            
            previousCoGuests.forEach((guest, index) => {
                const guestDiv = document.createElement('div');
                guestDiv.classList.add('flex', 'items-center', 'justify-between', 'p-4', 'bg-text-light/80', 'rounded-lg', 'border', 'border-tertiary-highlight/30');
                
                guestDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" id="previous-guest-${index}" value="${index}" class="h-5 w-5 text-secondary-accent focus:ring-secondary-accent border-tertiary-highlight/40 rounded">
                        <div>
                            <label for="previous-guest-${index}" class="font-medium text-gray-700">${guest.name}</label>
                            <p class="text-sm text-gray-500">${guest.phone_number} - ${guest.id_proof_type}</p>
                        </div>
                    </div>
                `;
                
                previousCoGuestsContainer.appendChild(guestDiv);
            });
            
            returningGuestSection.classList.remove('hidden');
            phoneCheckStatus.textContent = `Found ${previousCoGuests.length} previous co-guest(s)`;
            phoneCheckStatus.className = 'text-xs mt-1 text-tertiary-highlight';
            phoneCheckStatus.classList.remove('hidden');
            
            console.log('‚úÖ Returning guest section displayed');
        }

        /**
         * Handles confirmation of previous co-guests selection
         */
        function handleConfirmPreviousGuests() {
            selectedPreviousGuests = [];
            const checkboxes = previousCoGuestsContainer.querySelectorAll('input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const index = parseInt(checkbox.value);
                    selectedPreviousGuests.push(previousCoGuests[index]);
                }
            });
            
            console.log('‚úÖ Selected previous guests:', selectedPreviousGuests);
            
            // Add selected guests to the co-guest forms
            selectedPreviousGuests.forEach(guest => {
                createCoGuestForm(guest);
            });
            
            // Hide the returning guest section
            returningGuestSection.classList.add('hidden');
            
            showMessage(`Added ${selectedPreviousGuests.length} previous co-guest(s) to your registration`, 'success');
        }

        /**
         * Handles phone number input for returning guest detection
         */
        async function handlePhoneNumberCheck() {
            const phoneNumber = phoneNumberInput.value.trim();
            
            if (phoneNumber.length !== 10) {
                phoneCheckStatus.classList.add('hidden');
                returningGuestSection.classList.add('hidden');
                // Reset main guest form
                isMainGuestReturning = false;
                mainGuestPreviousData = null;
                updateMainGuestForm();
                return;
            }
            
            phoneCheckStatus.textContent = 'Checking for previous registrations...';
            phoneCheckStatus.className = 'text-xs mt-1 text-gray-600';
            phoneCheckStatus.classList.remove('hidden');
            
            try {
                console.log('üîÑ Starting phone number check...');
                const isReturningGuest = await checkReturningGuest(phoneNumber);
                console.log('üìû Phone check result:', isReturningGuest);
                
                if (isReturningGuest) {
                    updateMainGuestForm();
                    if (previousCoGuests.length > 0) {
                        displayPreviousCoGuests();
                    } else {
                        phoneCheckStatus.textContent = 'Returning guest - no previous co-guests found';
                        phoneCheckStatus.className = 'text-xs mt-1 text-tertiary-highlight';
                    }
                } else {
                    phoneCheckStatus.textContent = 'New guest - no previous registrations found';
                    phoneCheckStatus.className = 'text-xs mt-1 text-gray-600';
                    returningGuestSection.classList.add('hidden');
                    // Ensure main guest form is reset
                    isMainGuestReturning = false;
                    mainGuestPreviousData = null;
                    updateMainGuestForm();
                }
            } catch (error) {
                console.error('‚ùå Error checking returning guest:', error);
                phoneCheckStatus.textContent = 'Error checking previous registrations';
                phoneCheckStatus.className = 'text-xs mt-1 text-red-600';
                returningGuestSection.classList.add('hidden');
                // Reset main guest form on error
                isMainGuestReturning = false;
                mainGuestPreviousData = null;
                updateMainGuestForm();
            }
        }

        // =================================================================
        // REGISTRATION HANDLER - FIXED TO NOT RE-ASK ID PROOFS FOR RETURNING GUESTS
        // =================================================================

        async function handleRegistration(event) {
            event.preventDefault();
            toggleLoading(true);

            const form = event.target;
            const fileInput = document.getElementById('id-proof-file');
            const file = fileInput.files[0];
            const regId = generateRegId();
            const istTime = getISTTimeString();
            const phoneNumber = form['phone_number'].value;

            // For returning main guest, file is optional
            if (!isMainGuestReturning && !file) {
                showMessage('Please upload an ID Proof document for the main guest.', 'error');
                toggleLoading(false);
                return;
            }

            // Validate file size if a file is uploaded
            if (file && !validateFileSize(file)) {
                toggleLoading(false);
                return;
            }

            try {
                let idProofUrl = '';

                // 1. Upload Main Guest File only if provided and guest is not returning
                if (file && !isMainGuestReturning) {
                    const fileExtension = file.name.split('.').pop();
                    const storagePath = `guest_reg_uploads/${regId}.${fileExtension}`;

                    const { data: uploadData, error: uploadError } = await storage
                        .from('id-proofs')
                        .upload(storagePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) {
                        console.error('Storage Upload Error:', uploadError);
                        showMessage(`File upload failed: ${uploadError.message}`, 'error');
                        toggleLoading(false);
                        return;
                    }

                    // Get Public URL for new file
                    const { data: publicUrlData } = storage.from('id-proofs').getPublicUrl(storagePath);
                    idProofUrl = publicUrlData.publicUrl;
                } else if (isMainGuestReturning && mainGuestPreviousData) {
                    // Use existing ID proof URL for returning guest
                    idProofUrl = mainGuestPreviousData.id_proof_url;
                    console.log('‚úÖ Using existing ID proof for main guest:', idProofUrl);
                }

                // 2. Collect Co-Guest Data
                const coGuests = [];
                
                // Add selected previous guests (WITH THEIR EXISTING ID PROOF DATA)
                selectedPreviousGuests.forEach(guest => {
                    coGuests.push({
                        name: guest.name,
                        phone_number: guest.phone_number,
                        id_proof_type: guest.id_proof_type,
                        id_proof_url: guest.id_proof_url // Keep existing URL
                    });
                });
                
                // Add new co-guests (these will need file uploads)
                const coGuestForms = document.querySelectorAll('.co-guest-form');
                coGuestForms.forEach((form, index) => {
                    const formNumber = index + 1;
                    const nameInput = document.getElementById(`co-guest-name-${formNumber}`);
                    const phoneInput = document.getElementById(`co-guest-phone-${formNumber}`);
                    const typeSelect = document.getElementById(`co-guest-id-type-${formNumber}`);
                    const fileInput = document.getElementById(`co-guest-id-file-${formNumber}`);
                    
                    if (!nameInput || !phoneInput || !typeSelect) return;
                    
                    // Check if this is a previous guest (already added above)
                    const isPreviousGuest = selectedPreviousGuests.some(g => g.phone_number === phoneInput.value);
                    if (isPreviousGuest) return;
                    
                    // For new co-guests, require file upload
                    if (fileInput && fileInput.files[0]) {
                        const coGuestFile = fileInput.files[0];
                        
                        if (!validateFileSize(coGuestFile)) {
                            toggleLoading(false);
                            return;
                        }
                        
                        coGuests.push({
                            name: nameInput.value,
                            phone_number: phoneInput.value,
                            id_proof_type: typeSelect.value
                            // id_proof_url will be added after file upload below
                        });
                    } else {
                        // New co-guest but no file uploaded - show error
                        showMessage(`Please upload ID proof for co-guest: ${nameInput.value}`, 'error');
                        toggleLoading(false);
                        throw new Error('Missing file for new co-guest');
                    }
                });

                // 3. Upload Co-Guest Files ONLY FOR NEW CO-GUESTS
                for (let i = 0; i < coGuests.length; i++) {
                    const coGuest = coGuests[i];
                    
                    // Skip if this co-guest already has an ID proof URL (returning guest)
                    if (coGuest.id_proof_url) {
                        console.log(`Skipping file upload for returning co-guest: ${coGuest.name}`);
                        continue;
                    }
                    
                    // Only upload files for new co-guests (no existing id_proof_url)
                    const fileInput = document.getElementById(`co-guest-id-file-${i + 1}`);
                    
                    if (fileInput && fileInput.files[0]) {
                        const coGuestFile = fileInput.files[0];
                        const coGuestFileExtension = coGuestFile.name.split('.').pop();
                        const coGuestStoragePath = `guest_reg_uploads/${regId}_co${i + 1}.${coGuestFileExtension}`;

                        const { error: coGuestUploadError } = await storage
                            .from('id-proofs')
                            .upload(coGuestStoragePath, coGuestFile, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (coGuestUploadError) {
                            console.error('Co-Guest Storage Upload Error:', coGuestUploadError);
                            showMessage(`Co-guest file upload failed: ${coGuestUploadError.message}`, 'error');
                            toggleLoading(false);
                            return;
                        }

                        const { data: coGuestPublicUrlData } = storage.from('id-proofs').getPublicUrl(coGuestStoragePath);
                        coGuest.id_proof_url = coGuestPublicUrlData.publicUrl;
                    }
                }
                
                // 4. Insert Record
                const { error: insertError } = await supabaseClient
                    .from('guests')
                    .insert({
                        reg_id: regId,
                        guest_name: form['guest_name'].value,
                        phone_number: form['phone_number'].value,
                        check_in_date: form['check_in_date'].value,
                        check_out_date: form['check_out_date'].value,
                        purpose_of_visit: form['purpose_of_visit'].value,
                        id_proof_type: form['id_proof_type'].value,
                        id_proof_url: idProofUrl,
                        created_at_ist: istTime,
                        co_guests: JSON.stringify(coGuests)
                    });

                if (insertError) {
                    console.error('Database Insert Error:', insertError);
                    showMessage(`Registration failed: ${insertError.message}`, 'error');
                } else {
                    // Show thank you page with beautiful animations
                    registrationIdDisplay.textContent = regId;
                    thankYouPage.classList.remove('hidden');
                    createThankYouAnimations();
                    
                    // Reset form
                    form.reset();
                    coGuestContainer.innerHTML = '';
                    selectedPreviousGuests = [];
                    previousCoGuests = [];
                    isMainGuestReturning = false;
                    mainGuestPreviousData = null;
                    updateMainGuestForm();
                    addCoGuest(); // Add first co-guest form back
                    returningGuestSection.classList.add('hidden');
                    phoneCheckStatus.classList.add('hidden');
                }

            } catch (error) {
                if (error.message !== 'Missing file for new co-guest') {
                    console.error('An unexpected error occurred:', error);
                    showMessage('An unexpected error occurred during registration.', 'error');
                }
            } finally {
                toggleLoading(false);
            }
        }

        // =================================================================
        // ADMIN PORTAL - AUTH
        // =================================================================

        function toggleAdminMenu(open = null) {
            const sidebar = document.getElementById('admin-sidebar');
            const isOpen = sidebar.classList.contains('open');

            if (open === true && !isOpen) {
                sidebar.classList.add('open');
            } else if (open === false && isOpen) {
                sidebar.classList.remove('open');
            } else if (open === null) {
                sidebar.classList.toggle('open');
            }
        }

        async function handleAdminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const authMessage = document.getElementById('auth-message');
            authMessage.textContent = 'Logging in...';

            const { error } = await auth.signInWithPassword({ email, password });

            if (error) {
                authMessage.textContent = `Login failed: ${error.message}`;
            } else {
                authMessage.textContent = 'Success!';
            }
        }
        
        async function handleAdminLogout() {
            const { error } = await auth.signOut();
            if (error) {
                console.error('Logout error:', error);
                showMessage(`Logout failed: ${error.message}`, 'error');
            } else {
                showMessage('Successfully logged out', 'success');
            }
        }

        function updateAdminUI(user) {
            if (user) {
                adminUserIdSpan.textContent = user.id.substring(0, 8);
                adminAuthSection.classList.add('hidden');
                adminDataSection.classList.remove('hidden');
                fetchGuests();
            } else {
                adminAuthSection.classList.remove('hidden');
                adminDataSection.classList.add('hidden');
                document.getElementById('auth-message').textContent = '';
                adminUserIdSpan.textContent = 'N/A';
                guestListBody.innerHTML = '<tr id="loading-row" class="text-text-light text-center"><td colspan="6" class="p-4">Please log in.</td></tr>';
            }
        }

        async function generateSignedUrl(storagePath) {
            const urlParts = storagePath.split('id-proofs/');
            if (urlParts.length < 2) return ''; 
            const internalPath = urlParts[1];

            const { data, error } = await storage.from('id-proofs').createSignedUrl(internalPath, 60);

            if (error) {
                console.error('Error generating signed URL:', error);
                return '';
            }
            return data.signedUrl;
        }

        async function handleDownload(idProofUrl) {
            const downloadUrl = await generateSignedUrl(idProofUrl);
            if (downloadUrl) {
                window.open(downloadUrl, '_blank');
            } else {
                showMessage('Could not secure file access. Check RLS policies.', 'error');
            }
        }

        // =================================================================
        // ADMIN PORTAL - DATA FETCHING
        // =================================================================

        async function fetchGuests() {
            guestListBody.innerHTML = '<tr id="loading-row" class="text-text-light text-center"><td colspan="6" class="p-4"><div class="spinner h-6 w-6 border-4 rounded-full mx-auto"></div></td></tr>';
            
            let query = supabaseClient.from('guests').select('*');
            
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            
            if (startDate) {
                const utcStart = getAdjustedUTCFilterString(startDate, false);
                query = query.gte('created_at', utcStart);
            }
            
            if (endDate) {
                const utcEnd = getAdjustedUTCFilterString(endDate, true);
                query = query.lt('created_at', utcEnd);
            }

            query = query.order('created_at', { ascending: false });

            const { data: guests, error } = await query;

            if (error) {
                guestListBody.innerHTML = `<tr class="text-tertiary-highlight"><td colspan="6" class="p-4 text-center">Error fetching data: ${error.message}</td></tr>`;
                document.getElementById('guest-count').textContent = 'Error';
                return;
            }

            document.getElementById('guest-count').textContent = guests.length;
            guestListBody.innerHTML = '';

            if (guests.length === 0) {
                guestListBody.innerHTML = '<tr class="text-text-light/80"><td colspan="6" class="p-4 text-center">No registrations found.</td></tr>';
                return;
            }

            guests.forEach(guest => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-primary-dark/50', 'transition', 'duration-150');

                let coGuestData = [];
                let coGuestCount = 0;
                try {
                    coGuestData = JSON.parse(guest.co_guests || '[]');
                    coGuestCount = coGuestData.length;
                } catch (e) {
                    console.error("Failed to parse co_guests JSON:", e);
                }

                const coGuestListHTML = coGuestCount > 0 
                    ? `<ul class="list-disc pl-5 text-xs mt-1 text-text-light/80">
                        ${coGuestData.map(cg => `<li>${cg.name} (${cg.phone_number}) - ${cg.id_proof_type}</li>`).join('')}
                       </ul>`
                    : '<span class="text-xs text-text-light/60">None</span>';

                const coGuestIdProofs = coGuestCount > 0 
                    ? coGuestData.map((cg, index) => 
                        `<button onclick="handleDownload('${cg.id_proof_url}')" class="px-2 py-1 bg-tertiary-highlight text-text-light text-xs rounded-full hover:bg-secondary-accent transition duration-150 transform hover:scale-105 mt-1">
                            Co-Guest ${index + 1} ID
                        </button>`
                      ).join('<br>')
                    : '';

                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-text-light whitespace-nowrap">${guest.reg_id}</td>
                    <td class="px-4 py-3 text-sm text-text-light">
                        <span class="font-semibold">${guest.guest_name}</span><br>
                        <span class="text-xs text-text-light/80">${guest.phone_number}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-text-light">
                        Check-in: <span class="text-tertiary-highlight">${guest.check_in_date || 'N/A'}</span><br>
                        Check-out: <span class="text-tertiary-highlight">${guest.check_out_date || 'N/A'}</span><br>
                        <span class="text-xs text-text-light/80">Purpose: ${guest.purpose_of_visit || 'N/A'}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-text-light">
                        Main ID: <span class="font-semibold">${guest.id_proof_type || 'N/A'}</span><br>
                        <span class="text-xs text-text-light/80">Co-Guests (${coGuestCount}):</span>
                        ${coGuestListHTML}
                    </td>
                    <td class="px-4 py-3 text-xs text-text-light/80 whitespace-nowrap">${guest.created_at_ist || guest.created_at}</td>
                    <td class="px-4 py-3 text-sm whitespace-nowrap">
                        <button onclick="handleDownload('${guest.id_proof_url}')" class="px-3 py-1 bg-secondary-accent text-text-light text-xs rounded-full hover:bg-tertiary-highlight transition duration-150 transform hover:scale-105">
                            Main Guest ID
                        </button>
                        ${coGuestIdProofs ? `<div class="mt-2">${coGuestIdProofs}</div>` : ''}
                    </td>
                `;
                guestListBody.appendChild(tr);
            });
        }

        // =================================================================
        // EVENT LISTENERS & INITIALIZATION
        // =================================================================

        window.onload = function() {
            registrationForm.addEventListener('submit', handleRegistration);
            addGuestBtn.addEventListener('click', addCoGuest);
            adminLoginForm.addEventListener('submit', handleAdminLogin);
            logoutBtn.addEventListener('click', handleAdminLogout);

            auth.onAuthStateChange((event, session) => {
                updateAdminUI(session?.user ?? null);
            });

            phoneNumberInput.addEventListener('blur', handlePhoneNumberCheck);
            phoneNumberInput.addEventListener('input', function() {
                if (this.value.length !== 10) {
                    phoneCheckStatus.classList.add('hidden');
                    returningGuestSection.classList.add('hidden');
                    // Reset main guest form
                    isMainGuestReturning = false;
                    mainGuestPreviousData = null;
                    updateMainGuestForm();
                }
            });

            confirmPreviousGuestsBtn.addEventListener('click', handleConfirmPreviousGuests);

            newRegistrationBtn.addEventListener('click', function() {
                thankYouPage.classList.add('hidden');
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    toggleAdminMenu(false);
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    toggleAdminMenu(true);
                    const emailInput = document.getElementById('admin-email');
                    if (emailInput) {
                        setTimeout(() => emailInput.focus(), 300);
                    }
                }
            });
            
            // Add first co-guest form on load
            addCoGuest();

            function toggleAdminButtons() {
                const mainButton = document.getElementById('admin-menu-toggle');
                const compactButton = document.getElementById('admin-menu-toggle-compact');
                
                if (window.innerWidth < 768) {
                    mainButton.classList.add('hidden');
                    compactButton.classList.remove('hidden');
                } else {
                    mainButton.classList.remove('hidden');
                    compactButton.classList.add('hidden');
                }
            }

            toggleAdminButtons();
            window.addEventListener('resize', toggleAdminButtons);
        };

    </script>

</body>
</html>
